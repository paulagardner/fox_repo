----
title: "plots"
----
######################## ACTUALLY RUNNING THESE THINGS ########################
#would it make more sense to run the code in separate .R scripts and pull the information from theere? 
#for instance https://www.reddit.com/r/bioinformatics/comments/13hzttk/seeking_advice_on_managing_r_markdown_code_and/
#specifically, this comment? https://www.reddit.com/r/bioinformatics/comments/13hzttk/comment/jk9haps/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button
```{r}
#load packages and get base metadata to work with
library(tidyverse) #version in redfox conda: 2.0.0
library(googlesheets4) # 1.1.1
library(ggrepel) # 0.9.6
library(RColorBrewer) #1.1.3
library(grid) #4.4.3
library(gtable) #0.3.6
library(dplyr) #2.1.4
library(patchwork) #1.3.0
library(purrr)

# Import metadata from Google Sheets
sheet_url <- "https://docs.google.com/spreadsheets/d/1KBqsCfPiuyno90iRJ-O0wV0HIijFncstvcIpGnpGY0k/edit?gid=1838883534#gid=1838883534"
gs4_auth(path = "/gpfs/bio/xrq24scu/fox_repo/plotting/googlesheetskey.json") #you have to generate this json key from your google account
metadata <- read_sheet(sheet_url, sheet = "cluster_genomes_and_paths") %>%
  mutate(Sample = as.character(Sample)) %>%   # force only Sample to character
  rename(sample = Sample)


# Specify continent order manually (adjust as needed)
continent_order <- c("Europe", "WestAsia/NorthAfrica", "Asia", "Americas")


metadata <- metadata %>%
  mutate(continent = case_when(
    region %in% c("Russia", "West Russia", "East Russia", "North Russia", "China", "Xinjiang", "Japan", "India") ~ "Asia",
    region %in% c("Iraq", "Israel", "Saudi Arabia", "Mauritania", "Tunisia", "Morocco", "Iran", "Western Sahara") ~ "WestAsia/NorthAfrica",
    region %in% c("Canada", "Saskatchewan", "Nunavut", "Newfoundland", "Quebec", "United States", state.name) ~ "Americas",
    TRUE ~ "Europe"   # most of our unique countries will be in europe, so this makes sense
  ))

metadata$continent <- factor(metadata$continent, levels = continent_order) #convert from string to factor type, makes handling it
#in plots, for colors etc much easier 



#####
#Assign the color palette for the plots
#####
continent_colors <- setNames(RColorBrewer::brewer.pal(n = length(continent_order), name = "Set2"), continent_order)

plots_dir <- "/gpfs/data/bergstrom/paula/fox_repo/plotting/"

```


```{r}

plot_pca <- function(
    evec_path,               
    eval_path,               
    metadata,                
    excluded_samples = NULL, 
    point_label = c("sample", "region", "sample + region"),
    output_file,             
    plot_title = "PCA Plot",
    continent_colors,        
    width = 12,
    height = 10,
    poster = FALSE           
) {

  # Validate label options
  point_label <- match.arg(point_label)

  #### ------------------------------
  #### Load and clean PCA eigenvectors
  #### ------------------------------
  pca <- read_tsv(evec_path, show_col_types = FALSE, col_names = TRUE)

  # If the final column is non-numeric (e.g., "Control"), drop it safely
  if (!is.numeric(pca[[ncol(pca)]])) {
    message("Note: Dropping final non-numeric column from PCA file: ", colnames(pca)[ncol(pca)])
    pca <- pca[, -ncol(pca)]
  }

  # Rename PC columns (everything after the sample column)
  colnames(pca)[2:ncol(pca)] <- paste0("PC", 1:(ncol(pca) - 1))

  # Trim whitespace from sample IDs
  pca$sample <- stringr::str_trim(as.character(pca$sample))
  metadata$sample <- stringr::str_trim(as.character(metadata$sample))

  if (!is.null(excluded_samples)) {
    excluded_samples <- stringr::str_trim(excluded_samples)
  }

  #### ------------------------------
  #### Join metadata
  #### ------------------------------
  pca_meta <- left_join(pca, metadata, by = "sample")

  #### ------------------------------
  #### Filter excluded samples
  #### ------------------------------
  if (!is.null(excluded_samples)) {
    before_n <- nrow(pca_meta)
    pca_meta <- pca_meta %>% filter(!sample %in% excluded_samples)
    after_n <- nrow(pca_meta)

    message("Filtered out ", before_n - after_n, " samples.")
  }

  #### ------------------------------
  #### Load eigenvalues (variance explained)
  #### ------------------------------
  eigenvals <- scan(eval_path, quiet = TRUE)
  variance_explained <- 100 * eigenvals / sum(eigenvals)

  x_lab <- paste0("PC1 (", round(variance_explained[1], 1), "% variance)")
  y_lab <- paste0("PC2 (", round(variance_explained[2], 1), "% variance)")

  #### ------------------------------
  #### Label selection
  #### ------------------------------
  if (point_label == "sample") {
      label_aes <- aes(label = sample)
  } else if (point_label == "region") {
      label_aes <- aes(label = region)
  } else {  
      label_aes <- aes(label = paste0(sample, " (", region, ")"))
  }

  #### ------------------------------
  #### Poster settings override only text size + max overlaps
  #### ------------------------------
  if (poster) {
      text_size <- 5
      max_overlaps <- 20
  } else {
      text_size <- 3.5
      max_overlaps <- 35
  }

  #### ------------------------------
  #### Build plot
  #### ------------------------------
  p <- ggplot(pca_meta, aes(x = PC1, y = PC2, color = continent)) +
    geom_point(size = 3) +
    geom_text_repel(
      label_aes,
      size = text_size,
      box.padding = 0.5,
      max.overlaps = max_overlaps
    ) +
    theme_minimal(base_size = 15) +
    labs(title = plot_title, x = x_lab, y = y_lab) +
    theme(
      plot.title = element_text(size = 20, hjust = 0.5),
      axis.title = element_text(size = 15),
      axis.text = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14)
    ) +
    scale_color_manual(values = continent_colors)
    # coord_fixed() # optionally enable for nice aspect ratio

  #### ------------------------------
  #### Save plot
  #### ------------------------------
  ggsave(output_file, plot = p, width = width, height = height, dpi = 300)

  return(p)
}




#### generate two different plots 
excluded_samples <- readLines("/gpfs/data/bergstrom/paula/fox_repo/variant_calling/admixture/low_missingness_rm_outlier_removed_samples.txt")

# Normal PCA
pca_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers_tidy.evec", #this is named differently from the .pca.eval b/c I apply one of anders' custom scripts (in eigensoft.sh). make sure you #add this script to analyses
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers.pca.eval",
  metadata = metadata,
  excluded_samples = excluded_samples,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_large.png",
  plot_title = "PCA by Continent",
  continent_colors = continent_colors
)

# Poster Version
pca_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers_tidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers.pca.eval",
  metadata = metadata,
  excluded_samples = excluded_samples,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_poster.png",
  plot_title = "PCA by Continent",
  continent_colors = continent_colors,
  poster = TRUE 
)

# PCA including YPI1082
pca2_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpestidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes.pca.eval",
  metadata = metadata,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_large_withYPI1082.png",
  plot_title = "PCA with YPI1082",
  continent_colors = continent_colors
)
# YPI1082 Poster Version
pca2_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpestidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes.pca.eval",
  metadata = metadata,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_withYPI1082_poster.png",
  plot_title = "PCA with YPI1082",
  continent_colors = continent_colors,
  poster = TRUE
)


#################
# --- 1. Update metadata to include zsh2022 ---
metadata2 <- metadata %>%
  bind_rows(
    tibble(
      sample = "zsh2022",
      continent = "Asia",       # assign the correct continent
      region = "Corsac fox"        
    )
  )

# --- 2. Define file paths ---
evec_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/ypi1082_eigenstrat/Vvulpes_zsh2022_tidy.evec"
eval_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/ypi1082_eigenstrat/Vvulpes_zsh2022.pca.eval"

# --- 3. Call the plot_pca() function for normal plot ---
pca_zsh2022_plot <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata2,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_with_zsh2022.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors
)

# --- 4. Poster version ---
pca_zsh2022_plot_poster <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata2,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_with_zsh2022_poster.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors,
  poster = TRUE
)


##################################
#      ARCTIC FOXES + YPI1082
##################################
# --- 1. Update metadata to include arctic foxes ---
extraspecific_samples <- c("18049", "15075", "18005", "zsh2022")

metadata3 <- metadata %>%
  # remove any existing rows for these samples
  anti_join(tibble(sample = extraspecific_samples), by = "sample") %>%
  
  # add corrected rows
  bind_rows(
    tibble(
      sample = extraspecific_samples,
      continent = c("other", "other", "other", "other"),
      region = c("arctic fox", "arctic fox", "arctic fox", "corsac fox")
    )
  )

evec_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/ypi1082_eigenstrat/Vvulpes_vlagopus_tidy.evec"
eval_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/ypi1082_eigenstrat/Vvulpes_vlagopus.pca.eval"

pca_zsh2022_vlagopus_plot <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata3,
  point_label = "sample ",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/vlagopus_vvulpes.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors,
)

pca_zsh2022_vlagopus_plot_poster <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata3,
  point_label = "sample + region",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/vlagopus_vvulpes_poster.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors,
  poster = TRUE
)




```




```{r}
###################################### CLUMPAK/ADMIXTURE Plotting #####################################

# ----------- Set file paths -----------
q_file_base <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/admixture"
output_dir <- "/gpfs/data/bergstrom/paula/fox_repo/plotting"

# ----------- Read sample order from .fam file -----------
final_samples <- read.table(file.path(q_file_base, 
                                      "low_missingness_rm_outlier_snpmanualfilter.fam"),
                            header = FALSE)[,2]
final_samples_df <- data.frame(sample = final_samples, stringsAsFactors = FALSE)

# Join metadata to preserve sample info
qfileorder_df <- final_samples_df %>%
  left_join(metadata, by = "sample")


# Population IDs for ADMIXTOOLS (optional)
write.table(as.integer(factor(qfileorder_df$continent)),
            file.path(q_file_base, "popID.txt"),
            col.names = FALSE, row.names = FALSE)

# ----------- Order table & exclusions -----------
excluded <- readLines(file.path(q_file_base,
                                "low_missingness_rm_outlier_removed_samples.txt"))
order_df <- read_tsv(file.path(output_dir, "order.tsv"),
                     col_names = c("sample","region","continent"),
                     show_col_types = FALSE) %>%
  filter(!sample %in% excluded)

# Keep only relevant columns from metadata
metadata_sel <- metadata %>% select(sample, region, continent)

# Overwrite order_df values with metadata values where present
order_df <- order_df %>%
  left_join(metadata_sel, by = "sample") %>%
  mutate(
    region = ifelse(!is.na(region.y), region.y, region.x),
    continent = continent  # comes directly from metadata
  ) %>%
  select(sample, region, continent)

# ----------- Colors -----------
total_k <- 6
color_pal <- brewer.pal(min(12, total_k), "Paired")
continent_colors <- setNames(brewer.pal(n_distinct(order_df$continent), "Set2"),
                             unique(order_df$continent))

# ----------- Range of K values and Q files -----------
k_values <- 3:total_k
q_files <- file.path(q_file_base, paste0("CLUMPAK.", k_values, ".Q"))

# ----------- Dividers + label positions -----------
label_df <- order_df %>%
  mutate(sample = factor(sample, levels = order_df$sample),
         idx = as.numeric(sample))

dividers_df <- label_df %>%
  mutate(next_continent = lead(continent)) %>%
  filter(continent != next_continent) %>%
  transmute(sample = idx + 0.5, prop = 1)

# ----------- Helper function to plot one K -----------
plot_admix <- function(q_file, k) {
  q_data <- read.table(q_file, header = FALSE) %>%
    bind_cols(tibble(sample = final_samples))
  
  kdf2 <- order_df %>%
    left_join(q_data, by = "sample") %>%
    pivot_longer(starts_with("V"), names_to = "popGroup", values_to = "prop") %>%
    mutate(
      popGroup = factor(as.integer(str_remove(popGroup, "V"))),
      sample = factor(sample, levels = order_df$sample)
    )
  
  ggplot(kdf2, aes(x = sample, y = prop, fill = popGroup)) +
    geom_col(width = 1, color = "black") +
    geom_col(data = dividers_df, aes(x = sample, y = prop), fill = "white",
             width = 0.3, inherit.aes = FALSE) +
    scale_fill_manual(values = setNames(color_pal[seq_len(k)], seq_len(k))) +
    scale_color_manual(values = continent_colors) +
    coord_cartesian(clip = "off", ylim = c(-0.05, 1)) +
    theme_minimal() +
    labs(title = paste("ADMIXTURE Plot K =", k), x = NULL, y = "Ancestry Proportion") +
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.margin = margin(5, 10, 5, 10),
      legend.position = "none"  # remove legend entirely
    )
}

# ----------- Generate list of plots -----------
admix_plot_list <- map2(q_files, k_values, \(f, k) if (k <= total_k) plot_admix(f, k)) %>%
  compact()

# ----------- Combine plots (no legends) -----------
n <- length(admix_plot_list)
if (n == 0) stop("No ADMIXTURE plots to combine: check Q files and total_k.")

combined_plot <- map2(admix_plot_list, seq_len(n), \(p, i) {
  label_layer <- if (i == n) {
    geom_text(data = label_df, aes(x = sample, y = -0.02, label = region, color=continent),
              angle = 55, hjust = 1, size = 6, inherit.aes = FALSE)
  } else NULL #only add the country text labels to the very last plot
  
  p +                     # the original ggplot object for this K
  label_layer +          # optionally adds the region labels (or NULL for other plots)
  theme(                 # override/add theme elements
    legend.position = "none",             # removes the legend entirely
    axis.text.x = element_blank(),        # removes x-axis text
    axis.text.y = element_blank(),        # removes y-axis text
    axis.title = element_blank(),         # removes axis titles
    panel.grid = element_blank(),         # removes grid lines
    plot.margin = margin(10, 20, ifelse(i == n, 90, 5), 20)  
    # sets margins: top=10, right=20, bottom=80 for last plot (i==n) or 5 otherwise, left=20
  )
}) %>%
  wrap_plots(ncol = 1, heights = rep(1, n)) +
  plot_annotation(title = "ADMIXTURE Plots",
                  theme = theme(plot.title = element_text(size = 18, hjust = 0.5)))


ggsave(file.path(output_dir, "admixplots_all_clean.png"),
       plot = combined_plot,
       bg = 'transparent',
       width = 16,
       height = 9)
```


```{r}
# ==================
#   HETEROZYGOSITY 
# ==================

heterozygosity_url <- "https://docs.google.com/spreadsheets/d/1KBqsCfPiuyno90iRJ-O0wV0HIijFncstvcIpGnpGY0k/edit?gid=1838883534#gid=1838883534"
gs4_auth(path = "/gpfs/bio/xrq24scu/fox_repo/plotting/googlesheetskey.json")
heterozygosity_data <- read_sheet(heterozygosity_url, sheet = "HeterozygosityData") %>%
  mutate(Sample = as.character((Sample))) %>%
  rename(sample = Sample)

#get heterozygosity data merged w/ order_df (order.tsv with poor quality
#samples removed)
coverage_heterozygosity <- left_join(metadata, heterozygosity_data, by = "sample")

#Discard all data w/ a mean coverage below 15x, as indicated by which samples had 
#elevated heterozygosity (in your google plot)
filtered_cov_het <- coverage_heterozygosity[coverage_heterozygosity$mean_coverage > 15,]
# Remove samples with NA coverage
filtered_cov_het <- filtered_cov_het[!is.na(filtered_cov_het$mean_coverage),]
filtered_cov_het <- filtered_cov_het[filtered_cov_het$species == "Vulpes vulpes",]
filtered_cov_het <- filtered_cov_het[!is.na(filtered_cov_het$species),]

#now get this into a plotting order you like
# Join order with heterozygosity data
merged.df <- left_join(order_df, filtered_cov_het, by = "sample")

# Clean up duplicate columns: keep order_df's region/continent, drop the ".y"
merged.df <- merged.df %>%
  mutate(
    region = coalesce(region.x, region.y),
    continent = coalesce(continent.x, continent.y)
  ) %>%
  select(-region.x, -region.y, -continent.x, -continent.y)

# Drop samples with missing heterozygosity values
merged.df <- merged.df[!is.na(merged.df$Heterozygosity), ]

# Create combined sample label
merged.df$sample_region <- paste0(merged.df$sample, " (", merged.df$region, ")")

# Enforce order from order_df
merged.df$sample_region <- factor(
  merged.df$sample_region,
  levels = paste0(order_df$sample, " (", order_df$region, ")")
)

# Use continent colors from earlier
continent_colors <- setNames(
  RColorBrewer::brewer.pal(length(unique(order_df$continent)), "Set2"),
  unique(order_df$continent)
)

# Plot
heterozygosity_plot <- ggplot(merged.df, 
                              aes(x = sample_region, y = Heterozygosity, color = continent)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Heterozygosity - 2 * Jackknife_SE,
                    ymax = Heterozygosity + 2 * Jackknife_SE),
                width = 0.2, color = "black") +
  scale_color_manual(values = continent_colors) +
  theme_minimal() +
  labs(title = "Heterozygosity by Sample",
       x = "Sample (Region)",
       y = "Heterozygosity",
       color = "Continent") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("/gpfs/bio/xrq24scu/fox_repo/plotting/heterozygosity_plot.png",
       plot = heterozygosity_plot, width = 12, height = 6)


```

```{r}
library("ggh4x")

# === Parameters ===
mu  <- 4.5e-9   # mutation rate
gen <- 2        # generation time in years
MSMC_allsamples_dir <- "/gpfs/data/bergstrom/paula/fox_repo/MSMC/autosomal_popsize_msmc"

# === Load MSMC results for autosomes ===
MSMC_all_samples_files <- list.files(
  MSMC_allsamples_dir,
  pattern = "*\\.msmc\\.final\\.txt$",
  full.names = TRUE
)

msmc_allsamples <- do.call(rbind, lapply(MSMC_all_samples_files, function(f) {
  df <- read.table(f, header = TRUE)
  df$sample <- sub("^(.*)\\.msmc\\.final\\.txt$", "\\1", basename(f))
  df
}))

# === Annotate samples with continent and region ===
pop_lookup <- order_df %>%
  semi_join(filtered_cov_het, by = "sample") %>%
  select(sample, continent, region) %>%
  distinct()

msmc_annotated <- msmc_allsamples %>%
  left_join(pop_lookup, by = "sample") %>%
  filter(!is.na(continent))

# Force factor levels to match autosome palette
msmc_annotated$continent <- factor(
  msmc_annotated$continent,
  levels = names(continent_colors)
)

library(dplyr)
library(stringr)

# === Load pseudodiploid MSMC results ===
MSMC_pseudo_dir <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/X_chromosomes/MSMC/popsize_for_pseudodiploids"

MSMC_pseudo_files <- list.files(
  MSMC_pseudo_dir,
  pattern = "*.msmc.final.txt$",
  full.names = TRUE
)

if (length(MSMC_pseudo_files) == 0)
  stop("No pseudodiploid MSMC files found!")

msmc_pseudo <- do.call(rbind, lapply(MSMC_pseudo_files, function(f) {
  df <- read.table(f, header = TRUE)
  pair <- strsplit(sub("\\.msmc\\.final\\.txt$", "", basename(f)), "\\.")[[1]]
  df$sample1 <- pair[1]
  df$sample2 <- pair[2]
  df
}))

# Annotate pseudodiploids
msmc_pseudo <- msmc_pseudo %>%
  left_join(pop_lookup, by = c("sample1" = "sample")) %>%
  rename(continent1 = continent, region1 = region) %>%
  left_join(pop_lookup, by = c("sample2" = "sample")) %>%
  rename(continent2 = continent, region2 = region) %>%
  mutate(
    continent1 = as.character(continent1),
    continent2 = as.character(continent2),
    continent_pair = apply(
      cbind(continent1, continent2), 1,
      function(z) paste(sort(z), collapse = "-")
    ),
    pair_id = paste(sample1, sample2, sep = "_")
  )

# ====================================================================
# === MSMC FACET PLOTTING FUNCTION (bottom x-axis on all facets) ====
# ====================================================================

plot_msmc_facet <- function(
  msmc_data,
  mu,
  gen,
  panel_grouping_var,
  group_line_var,
  color_var,
  label_var = NULL,
  highlight_var = NULL,
  highlight_values = NULL,
  ncol_panels = 4,
  xlims = c(1e4, 1e7),
  ylims = c(1e3, 1e7),
  manual_colors = NULL,
  use_log_guides = TRUE,
  save_file = NULL
) {

  # ----- Optional filtering (highlighting) -----
  if (!is.null(highlight_values)) {
    if (is.null(highlight_var))
      stop("highlight_var must be supplied if highlight_values is used.")

    msmc_data <- msmc_data %>%
      dplyr::filter(.data[[highlight_var]] %in% highlight_values)

    if (nrow(msmc_data) == 0)
      stop("No rows left after filtering highlight_var/highlight_values.")
  }

  # ----- Determine color palette -----
  if (!is.null(manual_colors)) {
    palette_vals <- manual_colors
  } else {
    groups <- sort(unique(msmc_data[[color_var]]))
    palette_vals <- setNames(
      colorRampPalette(RColorBrewer::brewer.pal(8, "Dark2"))(length(groups)),
      groups
    )
  }

  # ====== LOG SCALE SECTION ======

  # ggh4x changed guide names in 0.3.x; use "log"
  if (use_log_guides) {
    x_scale <- scale_x_log10(limits = xlims)
    y_scale <- scale_y_log10(limits = ylims)
  } else {
    x_scale <- scale_x_log10(limits = xlims)
    y_scale <- scale_y_log10(limits = ylims)
  }


  # ----- label positions (optional) -----
  labels_df <- NULL
  if (!is.null(label_var)) {
    labels_df <- msmc_data %>%
      dplyr::group_by(across(all_of(c(panel_grouping_var, group_line_var)))) %>%
      slice_min((left_time_boundary / mu) * gen, n = 1) %>%
      dplyr::ungroup()
  }

  # ----- Build plot -----
  p <- ggplot(
    msmc_data,
    aes(
      x = (left_time_boundary / mu) * gen,
      y = (1 / lambda_00) / (2 * mu),
      group = .data[[group_line_var]],
      color = .data[[color_var]]
    )
  ) +
    geom_step(alpha = 0.9) +
    scale_color_manual(values = palette_vals) +
    x_scale +
    y_scale +
    ggh4x::facet_wrap2(
      as.formula(paste0("~", panel_grouping_var)),
      ncol = ncol_panels,
      scales = "fixed",
      axes = "all",
      strip = ggh4x::strip_vanilla()
    ) +
    theme_bw(base_size = 12) +
    theme(
      legend.position = "bottom",
      strip.text = element_text(size = 12, face = "bold"),
      axis.text.x.top = element_blank(),
      axis.ticks.x.top = element_blank(),
      axis.text.y.right = element_blank(),
      axis.ticks.y.right = element_blank()
    ) + 
  ggplot2::annotation_logticks(sides = "bl")  # <-- ADD THIS LINE HERE

  # optional labels
  if (!is.null(label_var)) {
    p <- p +
      ggrepel::geom_text_repel(
        data = labels_df,
        aes(label = .data[[label_var]]),
        size = 3,
        segment.color = NA
      )
  }

  if (!is.null(save_file)) {
    ggsave(save_file, p, width = 12, height = 8, dpi = 300)
  }

  return(p)
}





# ====================================================================
# === PLOTS ==========================================================
# ====================================================================

autosomal_plot <- plot_msmc_facet(
  msmc_data = msmc_annotated,
  mu = mu,
  gen = gen,
  panel_grouping_var = "continent",
  color_var = "continent",
  group_line_var = "sample",
  label_var = "region",
  ncol_panels = 2,
  xlims = c(1e4, 1e7),
  ylims = c(1e3, 1e7),
  manual_colors = continent_colors,
  save_file = file.path(plots_dir, "msmc_all_samples_facet.png")
)

highlight_plot <- plot_msmc_facet(
  msmc_data = msmc_annotated,
  mu = mu,
  gen = gen,
  panel_grouping_var = "continent",
  color_var = "continent",
  group_line_var = "sample",
  label_var = "region",
  highlight_var = "sample",
  highlight_values = highlight_samples,
  ncol_panels = 2,
  ylims = c(1e3, 1e7),
  manual_colors = continent_colors,
  save_file = file.path(plots_dir, "msmc_highlight_samples_facet.png")
)

pseudo_mu <- mu * 0.75

pseudodip_plot <- plot_msmc_facet(
  msmc_data = msmc_pseudo,
  mu = pseudo_mu,
  gen = gen,
  panel_grouping_var = "continent_pair",
  color_var = "continent_pair",
  group_line_var = "pair_id",
  ncol_panels = 4,
  xlims = c(1e5, 1e7),
  ylims = c(1e3, 1e8),
  save_file = file.path(plots_dir, "MSMC_pseudodiploids_facet.png")
)

# Keep only the continent pairs you want
pseudo_asia <- msmc_pseudo %>%
  filter(continent_pair %in% c("Asia-WestAsia/NorthAfrica", "Americas-Asia", "Asia-Europe")) #sensitive to actual names in the original df, so make sure orders aren't reversed, etc

asia_pseudodip_plot <- plot_msmc_facet(
  msmc_data = pseudo_asia, 
  mu = pseudo_mu,
  gen = gen,
  panel_grouping_var = "continent_pair",
  color_var = "continent_pair",
  group_line_var = "pair_id",
  ncol_panels = 2,
  xlims = c(1e5, 5e6),
  ylims = c(7e3, 1e9),
  save_file = file.path(plots_dir, "MSMC_pseudodiploids_asia.png")
)
```



```{r}
library(ggplot2)
library(ggrepel)
library(dplyr)

plot_pseudodip_overlay <- function(pseudo_pair, autosomal_data, mu, pseudodip_mu, gen, save_file) {
  
  # --- Prepare pseudodiploid line ---
  pseudo_line <- pseudo_pair %>%
    mutate(
      time_years = (left_time_boundary / pseudodip_mu) * gen,
      Ne = (1 / lambda_00) / (2 * pseudodip_mu),
      type = "pseudodiploid",
      label = type
    )
  
  # --- Prepare autosomal lines ---
  auto1 <- autosomal_data %>% filter(sample %in% pseudo_pair$sample1) %>%
    mutate(
      time_years = (left_time_boundary / mu) * gen,
      Ne = (1 / lambda_00) / (2 * mu),
      type = paste0("autosome_", sample),
      label = sample
    )
  auto2 <- autosomal_data %>% filter(sample %in% pseudo_pair$sample2) %>%
    mutate(
      time_years = (left_time_boundary / mu) * gen,
      Ne = (1 / lambda_00) / (2 * mu),
      type = paste0("autosome_", sample),
      label = sample
    )
  
  # --- Combine ---
  plot_df <- bind_rows(pseudo_line, auto1, auto2) %>%
    filter(time_years > 0, Ne > 0)
  
  # --- Color palette ---
  palette_vals <- c(
    "pseudodiploid" = "red",
    setNames(RColorBrewer::brewer.pal(8, "Set1")[1:2], unique(c(auto1$sample, auto2$sample)))
  )
  
  # --- Label positions ---
  labels_df <- plot_df %>%
    group_by(type) %>%
    slice_max(time_years, n = 1) %>%  # position labels at largest time
    ungroup()
  
  # --- Build plot ---
  p <- ggplot(plot_df, aes(x = time_years, y = Ne, color = type, group = type)) +
    geom_step(size = 1) +
    geom_text_repel(data = labels_df, aes(label = label), size = 3, nudge_x = 0, segment.color = NA) +
    scale_color_manual(values = palette_vals) +
    scale_x_log10() + scale_y_log10() +
    theme_bw(base_size = 12) +
    theme(
      legend.position = "none",
      axis.ticks = element_line(),
      axis.text = element_text(size = 10),
      axis.title = element_text(size = 12)
    ) +
    annotation_logticks(sides = "bl") +
    labs(x = "Time (years)", y = "Ne")
  
  # --- Save plot ---
  if (!is.null(save_file)) {
    ggsave(save_file, p, width = 10, height = 6, dpi = 300)
  }
  
  return(p)
}

# --- Loop over all pairs ---
output_dir <- file.path(plots_dir, "msmc_pseudodiploids_individual_pairs")
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

for (pair_id in unique(msmc_pseudo$pair_id)) {
  pseudo_pair <- msmc_pseudo %>% filter(pair_id == !!pair_id)
  save_file <- file.path(output_dir, paste0(pair_id, ".png"))
  plot_pseudodip_overlay(pseudo_pair, msmc_annotated, mu, mu*0.75, gen, save_file)
  message("Saved plot for pair: ", pair_id)
}
```


```{r}
########## attempts to combine everything

library("ggh4x")

# === Parameters ===
mu  <- 4.5e-9   # mutation rate
gen <- 2        # generation time in years
MSMC_allsamples_dir <- "/gpfs/data/bergstrom/paula/fox_repo/MSMC/autosomal_popsize_msmc"

# === Load MSMC results for autosomes ===
MSMC_all_samples_files <- list.files(
  MSMC_allsamples_dir,
  pattern = "*\\.msmc\\.final\\.txt$",
  full.names = TRUE
)

msmc_allsamples <- do.call(rbind, lapply(MSMC_all_samples_files, function(f) {
  df <- read.table(f, header = TRUE)
  df$sample <- sub("^(.*)\\.msmc\\.final\\.txt$", "\\1", basename(f))
  df
}))

# === Annotate samples with continent and region ===
pop_lookup <- order_df %>%
  semi_join(filtered_cov_het, by = "sample") %>%
  select(sample, continent, region) %>%
  distinct()

msmc_annotated <- msmc_allsamples %>%
  left_join(pop_lookup, by = "sample") %>%
  filter(!is.na(continent))

# Force factor levels to match autosome palette
msmc_annotated$continent <- factor(
  msmc_annotated$continent,
  levels = names(continent_colors)
)

library(dplyr)
library(stringr)

# === Load pseudodiploid MSMC results ===
MSMC_pseudo_dir <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/X_chromosomes/MSMC/popsize_for_pseudodiploids"

MSMC_pseudo_files <- list.files(
  MSMC_pseudo_dir,
  pattern = "*.msmc.final.txt$",
  full.names = TRUE
)

if (length(MSMC_pseudo_files) == 0)
  stop("No pseudodiploid MSMC files found!")

msmc_pseudo <- do.call(rbind, lapply(MSMC_pseudo_files, function(f) {
  df <- read.table(f, header = TRUE)
  pair <- strsplit(sub("\\.msmc\\.final\\.txt$", "", basename(f)), "\\.")[[1]]
  df$sample1 <- pair[1]
  df$sample2 <- pair[2]
  df
}))

# Annotate pseudodiploids
msmc_pseudo <- msmc_pseudo %>%
  left_join(pop_lookup, by = c("sample1" = "sample")) %>%
  rename(continent1 = continent, region1 = region) %>%
  left_join(pop_lookup, by = c("sample2" = "sample")) %>%
  rename(continent2 = continent, region2 = region) %>%
  mutate(
    continent1 = as.character(continent1),
    continent2 = as.character(continent2),
    continent_pair = apply(
      cbind(continent1, continent2), 1,
      function(z) paste(sort(z), collapse = "-")
    ),
    pair_id = paste(sample1, sample2, sep = "_")
  )

# =======
plot_msmc_facet <- function(
  msmc_data,
  mu,
  gen,
  panel_grouping_var,
  group_line_var,
  color_var,
  label_var = NULL,
  highlight_var = NULL,
  highlight_values = NULL,
  autosomal_data = NULL,         # NEW
  pseudodip_mu = NULL,           # NEW
  overlay_autosomes = FALSE,     # NEW
  ncol_panels = 4,
  xlims = c(1e4, 1e7),
  ylims = c(1e3, 1e7),
  manual_colors = NULL,
  use_log_guides = TRUE,
  save_file = NULL
) {

  # =============================================================
  # ========== 1. OPTIONALLY BUILD PSEUDODIP OVERLAY  ============
  # =============================================================

  if (overlay_autosomes) {

    if (is.null(autosomal_data) || is.null(pseudodip_mu))
      stop("Must supply autosomal_data and pseudodip_mu when overlay_autosomes = TRUE")

    # extract pair’s two chromosomes
    s1 <- unique(msmc_data$sample1)
    s2 <- unique(msmc_data$sample2)

    # pseudodip line
    pseudo_line <- msmc_data %>%
      mutate(
        time_years = (left_time_boundary / pseudodip_mu) * gen,
        Ne = (1 / lambda_00) / (2 * pseudodip_mu),
        type = "pseudodiploid",
        label = "pseudodiploid"
      )

    # autosomal lines
    auto1 <- autosomal_data %>% filter(sample == s1) %>%
      mutate(
        time_years = (left_time_boundary / mu) * gen,
        Ne = (1 / lambda_00) / (2 * mu),
        type = paste0("autosome_", sample),
        label = sample
      )

    auto2 <- autosomal_data %>% filter(sample == s2) %>%
      mutate(
        time_years = (left_time_boundary / mu) * gen,
        Ne = (1 / lambda_00) / (2 * mu),
        type = paste0("autosome_", sample),
        label = sample
      )

    # combine
    msmc_data <- bind_rows(pseudo_line, auto1, auto2)

    # override grouping + color variables
    group_line_var <- "type"
    color_var <- "type"
    panel_grouping_var <- panel_grouping_var

    # build palette
    manual_colors <- c(
      "pseudodiploid" = "red",
      setNames(
        RColorBrewer::brewer.pal(8, "Set1")[1:2],
        c(paste0("autosome_", s1), paste0("autosome_", s2))
      )
    )
  }

  # =============================================================
  # ========== 2. OPTIONAL FILTERING (HIGHLIGHT)  =================
  # =============================================================

  if (!is.null(highlight_values) && !overlay_autosomes) {
    if (is.null(highlight_var))
      stop("highlight_var must be supplied if highlight_values is used.")

    msmc_data <- msmc_data %>%
      dplyr::filter(.data[[highlight_var]] %in% highlight_values)

    if (nrow(msmc_data) == 0)
      stop("No rows left after filtering highlight_var/highlight_values.")
  }

  # =============================================================
  # ========== 3. DETERMINE COLOR PALETTE ========================
  # =============================================================

  if (!is.null(manual_colors)) {
    palette_vals <- manual_colors
  } else {
    groups <- sort(unique(msmc_data[[color_var]]))
    palette_vals <- setNames(
      colorRampPalette(RColorBrewer::brewer.pal(8, "Dark2"))(length(groups)),
      groups
    )
  }

  # =============================================================
  # ========== 4. OPTIONAL LABEL CALCULATION =====================
  # =============================================================

  labels_df <- NULL
  if (!is.null(label_var)) {
    # if overlay_autosomes, "time_years" already exists
    if (overlay_autosomes) {
      labels_df <- msmc_data %>%
        group_by(type) %>%
        slice_max(time_years, n = 1) %>%
        ungroup()
    } else {
      labels_df <- msmc_data %>%
        dplyr::group_by(across(all_of(c(panel_grouping_var, group_line_var)))) %>%
        slice_min((left_time_boundary / mu) * gen, n = 1) %>%
        dplyr::ungroup()
    }
  }

  # =============================================================
  # ========== 5. BUILD MAIN PLOT ================================
  # =============================================================

  p <- ggplot(
    msmc_data,
    aes(
      x = if (!overlay_autosomes) (left_time_boundary / mu) * gen else time_years,
      y = if (!overlay_autosomes) (1 / lambda_00) / (2 * mu) else Ne,
      group = .data[[group_line_var]],
      color = .data[[color_var]]
    )
  ) +
    geom_step(alpha = 0.9) +
    scale_color_manual(values = palette_vals) +
    scale_x_log10(limits = xlims) +
    scale_y_log10(limits = ylims)

  # faceting only for non-overlay
  if (!overlay_autosomes) {
    p <- p + ggh4x::facet_wrap2(
      as.formula(paste0("~", panel_grouping_var)),
      ncol = ncol_panels,
      scales = "fixed",
      axes = "all",
      strip = ggh4x::strip_vanilla()
    )
  }

  p <- p +
    theme_bw(base_size = 12) +
    theme(
      legend.position = if (overlay_autosomes) "none" else "bottom",
      strip.text = element_text(size = 12, face = "bold"),
      axis.text.x.top = element_blank(),
      axis.ticks.x.top = element_blank(),
      axis.text.y.right = element_blank(),
      axis.ticks.y.right = element_blank()
    ) +
    annotation_logticks(sides = "bl")

  # optional labels
  if (!is.null(label_var)) {
    p <- p +
      geom_text_repel(
        data = labels_df,
        aes(label = .data[[label_var]]),
        size = 3,
        segment.color = NA
      )
  }

  if (!is.null(save_file)) {
    ggsave(save_file, p, width = 12, height = 8, dpi = 300)
  }

  return(p)
}



autosomal_plot <- plot_msmc_facet(
  msmc_data = msmc_annotated,
  mu = mu,
  gen = gen,
  panel_grouping_var = "continent",
  color_var = "continent",
  group_line_var = "sample",
  label_var = "region",
  ncol_panels = 2,
  xlims = c(1e4, 1e7),
  ylims = c(1e3, 1e7),
  manual_colors = continent_colors,
  save_file = file.path(plots_dir, "msmc_all_samples_facet.png")
)

highlight_plot <- plot_msmc_facet(
  msmc_data = msmc_annotated,
  mu = mu,
  gen = gen,
  panel_grouping_var = "continent",
  color_var = "continent",
  group_line_var = "sample",
  label_var = "region",
  highlight_var = "sample",
  highlight_values = highlight_samples,
  ncol_panels = 2,
  ylims = c(1e3, 1e7),
  manual_colors = continent_colors,
  save_file = file.path(plots_dir, "msmc_highlight_samples_facet.png")
)

pseudo_mu <- mu * 0.75

pseudodip_plot <- plot_msmc_facet(
  msmc_data = msmc_pseudo,
  mu = pseudo_mu,
  gen = gen,
  panel_grouping_var = "continent_pair",
  color_var = "continent_pair",
  group_line_var = "pair_id",
  ncol_panels = 4,
  xlims = c(1e5, 1e7),
  ylims = c(1e3, 1e8),
  save_file = file.path(plots_dir, "MSMC_pseudodiploids_facet.png")
)

# Keep only the continent pairs you want
pseudo_asia <- msmc_pseudo %>%
  filter(continent_pair %in% c("Asia-WestAsia/NorthAfrica", "Americas-Asia", "Asia-Europe")) #sensitive to actual names in the original df, so make sure orders aren't reversed, etc

asia_pseudodip_plot <- plot_msmc_facet(
  msmc_data = pseudo_asia, 
  mu = pseudo_mu,
  gen = gen,
  panel_grouping_var = "continent_pair",
  color_var = "continent_pair",
  group_line_var = "pair_id",
  ncol_panels = 2,
  xlims = c(1e5, 5e6),
  ylims = c(7e3, 1e9),
  save_file = file.path(plots_dir, "MSMC_pseudodiploids_asia.png")


# Correctly create the subdirectory
pseudodiploids_dir <- file.path(plots_dir, "msmc_pseudodiploids_individual_pairs")
if (!dir.exists(pseudodiploids_dir)) {
    dir.create(pseudodiploids_dir, recursive = TRUE)
}

# Loop over all pseudodiploid pairs
for (pair_id in unique(msmc_pseudo$pair_id)) {

  pseudo_pair <- msmc_pseudo %>% 
    filter(pair_id == !!pair_id)

  # Ensure each plot is saved in the correct subdirectory
  save_file <- file.path(
    pseudodiploids_dir, 
    paste0(pair_id, ".png")
  )
  
  plot_msmc_facet(
    msmc_data = pseudo_pair,
    mu = mu,
    pseudodip_mu = pseudo_mu,
    gen = gen,
    overlay_autosomes = TRUE,
    autosomal_data = msmc_annotated,
    panel_grouping_var = "pair_id",
    group_line_var = "type",    
    color_var = "type",           
    save_file = save_file,
    xlims = c(1e4, 1e7),
    ylims = c(1e3, 1e8)
  )
}
```

