----
title: "plots"
----
######################## ACTUALLY RUNNING THESE THINGS ########################
#would it make more sense to run the code in separate .R scripts and pull the information from theere? 
#for instance https://www.reddit.com/r/bioinformatics/comments/13hzttk/seeking_advice_on_managing_r_markdown_code_and/
#specifically, this comment? https://www.reddit.com/r/bioinformatics/comments/13hzttk/comment/jk9haps/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button
```{r}
#load packages and get base metadata to work with
library(tidyverse) #version in redfox conda: 2.0.0
library(googlesheets4) # 1.1.1
library(ggrepel) # 0.9.6
library(RColorBrewer) #1.1.3
library(grid) #4.4.3
library(gtable) #0.3.6
library(dplyr) #2.1.4
library(patchwork) #1.3.0
library(purrr)

# Import metadata from Google Sheets
sheet_url <- "https://docs.google.com/spreadsheets/d/1KBqsCfPiuyno90iRJ-O0wV0HIijFncstvcIpGnpGY0k/edit?gid=1838883534#gid=1838883534"
gs4_auth(path = "/gpfs/bio/xrq24scu/fox_repo/plotting/googlesheetskey.json") #you have to generate this json key from your google account
metadata <- read_sheet(sheet_url, sheet = "cluster_genomes_and_paths") %>%
  mutate(Sample = as.character(Sample)) %>%   # force only Sample to character
  rename(sample = Sample)


# Specify continent order manually (adjust as needed)
continent_order <- c("Europe", "WestAsia/NorthAfrica", "Asia", "Americas")


metadata <- metadata %>%
  mutate(continent = case_when(
    region %in% c("Russia", "West Russia", "East Russia", "North Russia", "China", "Xinjiang", "Japan", "India") ~ "Asia",
    region %in% c("Iraq", "Israel", "Saudi Arabia", "Mauritania", "Tunisia", "Morocco", "Iran", "Western Sahara") ~ "WestAsia/NorthAfrica",
    region %in% c("Canada", "Saskatchewan", "Nunavut", "Newfoundland", "Quebec", "United States", state.name) ~ "Americas",
    TRUE ~ "Europe"   # most of our unique countries will be in europe, so this makes sense
  ))

metadata$continent <- factor(metadata$continent, levels = continent_order) #convert from string to factor type, makes handling it
#in plots, for colors etc much easier 



#####
#Assign the color palette for the plots
#####
continent_colors <- setNames(RColorBrewer::brewer.pal(n = length(continent_order), name = "Set2"), continent_order)

plots_dir <- "/gpfs/data/bergstrom/paula/fox_repo/plotting/"

```


```{r}

# Function to generate PCA plot
plot_pca <- function(
    evec_path,          # path to .evec file
    eval_path,          # path to .pca.eval file
    metadata,           # metadata dataframe
    excluded_samples = NULL, # optional vector of samples to exclude
    point_label = c("sample", "region"), # whether to label by sample+region or just region
    output_file,        # path to save plot
    plot_title = "PCA Plot",  # plot title
    continent_colors,   # named vector of continent colors
    width = 12,
    height = 10,
    poster = FALSE      # if TRUE, use poster version formatting
) {
  
  point_label <- match.arg(point_label)
  
  # Load PCA eigenvectors
  pca <- read_tsv(evec_path)
  colnames(pca)[2:ncol(pca)] <- paste0("PC", 1:(ncol(pca) - 1))
  
  # Join metadata
  pca_meta <- left_join(pca, metadata, by = "sample")
  
  # Filter excluded samples if provided
  if (!is.null(excluded_samples)) {
    pca_meta <- pca_meta %>% filter(!sample %in% excluded_samples)
  }
  
  # Read eigenvalues and compute variance explained
  eigenvals <- scan(eval_path)
  variance_explained <- 100 * eigenvals / sum(eigenvals)
  
  x_lab <- paste0("PC1 (", round(variance_explained[1], 1), "% variance)")
  y_lab <- paste0("PC2 (", round(variance_explained[2], 1), "% variance)")
  
  # Determine labels
  if (poster) {
    label_aes <- aes(label = region)
    text_size <- 5
    max_overlaps <- 20
  } else {
    label_aes <- if (point_label == "region") aes(label = region) else aes(label = paste0(sample, " (", region, ")"))
    text_size <- 3.5
    max_overlaps <- 35
  }

# Create plot
p <- ggplot(pca_meta, aes(x = PC1, y = PC2, color = continent)) +
  geom_point(size = 3) +
  geom_text_repel(label_aes, size = text_size, box.padding = 0.5, max.overlaps = max_overlaps) +
  theme_minimal(base_size = 15) +
  labs(title = plot_title, x = x_lab, y = y_lab) +
  theme(
    plot.title = element_text(size = 20, hjust = 0.5),
    axis.title = element_text(size = 15),
    axis.text = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14)
  ) +
  scale_color_manual(values = continent_colors) #+
  #coord_fixed() # comment out the + and coord_fixed if you want a nice square aspect ratio,
                # as this makes 1 unit in x = 1 unit in y. This overrides any ggsave options

  
  # Save plot
  ggsave(output_file, plot = p, width = width, height = height, dpi = 300)
  
  return(p)
}





#### generate two different plots 
excluded_samples <- readLines("/gpfs/data/bergstrom/paula/fox_repo/variant_calling/admixture/low_missingness_rm_outlier_removed_samples.txt")

# Normal PCA
pca_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers_tidy.evec", #this is named differently from the .pca.eval b/c I apply one of anders' custom scripts (in eigensoft.sh). make sure you #add this script to analyses
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers.pca.eval",
  metadata = metadata,
  excluded_samples = excluded_samples,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_large.png",
  plot_title = "PCA by Continent",
  continent_colors = continent_colors
)

# Poster Version
pca_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers_tidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_rmoutliers.pca.eval",
  metadata = metadata,
  excluded_samples = excluded_samples,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_poster.png",
  plot_title = "PCA by Continent",
  continent_colors = continent_colors,
  poster = TRUE 
)

# PCA including YPI1082
pca2_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpestidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes.pca.eval",
  metadata = metadata,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_large_withYPI1082.png",
  plot_title = "PCA with YPI1082",
  continent_colors = continent_colors
)
# YPI1082 Poster Version
pca2_plot <- plot_pca(
  evec_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpestidy.evec",
  eval_path = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes.pca.eval",
  metadata = metadata,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_withYPI1082_poster.png",
  plot_title = "PCA with YPI1082",
  continent_colors = continent_colors,
  poster = TRUE
)


#################
# --- 1. Update metadata to include zsh2022 ---
metadata2 <- metadata %>%
  bind_rows(
    tibble(
      sample = "zsh2022",
      continent = "Asia",       # assign the correct continent
      region = "Unknown"        # replace with actual region if known
    )
  )

# --- 2. Define file paths ---
evec_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/corsac_eigenstrat/Vvulpes_zsh2022_tidy.evec"
eval_path <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/Eigenstrat/Vvulpes_zsh2022.pca.eval"

# --- 3. Call the plot_pca() function for normal plot ---
pca_zsh2022_plot <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata2,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_with_zsh2022.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors
)

# --- 4. Poster version ---
pca_zsh2022_plot_poster <- plot_pca(
  evec_path = evec_path,
  eval_path = eval_path,
  metadata = metadata2,
  point_label = "sample",
  output_file = "/gpfs/bio/xrq24scu/fox_repo/plotting/PCA_plot_with_zsh2022_poster.png",
  plot_title = "PCA including zsh2022",
  continent_colors = continent_colors,
  poster = TRUE
)

```




```{r}
###################################### CLUMPAK/ADMIXTURE Plotting #####################################

# ----------- Set file paths -----------
q_file_base <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/admixture"
output_dir <- "/gpfs/data/bergstrom/paula/fox_repo/plotting"

# ----------- Read sample order from .fam file -----------
final_samples <- read.table(file.path(q_file_base, 
                                      "low_missingness_rm_outlier_snpmanualfilter.fam"),
                            header = FALSE)[,2]
final_samples_df <- data.frame(sample = final_samples, stringsAsFactors = FALSE)

# Join metadata to preserve sample info
qfileorder_df <- final_samples_df %>%
  left_join(metadata, by = "sample")


# Population IDs for ADMIXTOOLS (optional)
write.table(as.integer(factor(qfileorder_df$continent)),
            file.path(q_file_base, "popID.txt"),
            col.names = FALSE, row.names = FALSE)

# ----------- Order table & exclusions -----------
excluded <- readLines(file.path(q_file_base,
                                "low_missingness_rm_outlier_removed_samples.txt"))
order_df <- read_tsv(file.path(output_dir, "order.tsv"),
                     col_names = c("sample","region","continent"),
                     show_col_types = FALSE) %>%
  filter(!sample %in% excluded)

# Keep only relevant columns from metadata
metadata_sel <- metadata %>% select(sample, region, continent)

# Overwrite order_df values with metadata values where present
order_df <- order_df %>%
  left_join(metadata_sel, by = "sample") %>%
  mutate(
    region = ifelse(!is.na(region.y), region.y, region.x),
    continent = continent  # comes directly from metadata
  ) %>%
  select(sample, region, continent)

# ----------- Colors -----------
total_k <- 6
color_pal <- brewer.pal(min(12, total_k), "Paired")
continent_colors <- setNames(brewer.pal(n_distinct(order_df$continent), "Set2"),
                             unique(order_df$continent))

# ----------- Range of K values and Q files -----------
k_values <- 3:total_k
q_files <- file.path(q_file_base, paste0("CLUMPAK.", k_values, ".Q"))

# ----------- Dividers + label positions -----------
label_df <- order_df %>%
  mutate(sample = factor(sample, levels = order_df$sample),
         idx = as.numeric(sample))

dividers_df <- label_df %>%
  mutate(next_continent = lead(continent)) %>%
  filter(continent != next_continent) %>%
  transmute(sample = idx + 0.5, prop = 1)

# ----------- Helper function to plot one K -----------
plot_admix <- function(q_file, k) {
  q_data <- read.table(q_file, header = FALSE) %>%
    bind_cols(tibble(sample = final_samples))
  
  kdf2 <- order_df %>%
    left_join(q_data, by = "sample") %>%
    pivot_longer(starts_with("V"), names_to = "popGroup", values_to = "prop") %>%
    mutate(
      popGroup = factor(as.integer(str_remove(popGroup, "V"))),
      sample = factor(sample, levels = order_df$sample)
    )
  
  ggplot(kdf2, aes(x = sample, y = prop, fill = popGroup)) +
    geom_col(width = 1, color = "black") +
    geom_col(data = dividers_df, aes(x = sample, y = prop), fill = "white",
             width = 0.3, inherit.aes = FALSE) +
    scale_fill_manual(values = setNames(color_pal[seq_len(k)], seq_len(k))) +
    scale_color_manual(values = continent_colors) +
    coord_cartesian(clip = "off", ylim = c(-0.05, 1)) +
    theme_minimal() +
    labs(title = paste("ADMIXTURE Plot K =", k), x = NULL, y = "Ancestry Proportion") +
    theme(
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      plot.margin = margin(5, 10, 5, 10),
      legend.position = "none"  # remove legend entirely
    )
}

# ----------- Generate list of plots -----------
admix_plot_list <- map2(q_files, k_values, \(f, k) if (k <= total_k) plot_admix(f, k)) %>%
  compact()

# ----------- Combine plots (no legends) -----------
n <- length(admix_plot_list)
if (n == 0) stop("No ADMIXTURE plots to combine: check Q files and total_k.")

combined_plot <- map2(admix_plot_list, seq_len(n), \(p, i) {
  label_layer <- if (i == n) {
    geom_text(data = label_df, aes(x = sample, y = -0.02, label = region, color=continent),
              angle = 55, hjust = 1, size = 6, inherit.aes = FALSE)
  } else NULL #only add the country text labels to the very last plot
  
  p +                     # the original ggplot object for this K
  label_layer +          # optionally adds the region labels (or NULL for other plots)
  theme(                 # override/add theme elements
    legend.position = "none",             # removes the legend entirely
    axis.text.x = element_blank(),        # removes x-axis text
    axis.text.y = element_blank(),        # removes y-axis text
    axis.title = element_blank(),         # removes axis titles
    panel.grid = element_blank(),         # removes grid lines
    plot.margin = margin(10, 20, ifelse(i == n, 90, 5), 20)  
    # sets margins: top=10, right=20, bottom=80 for last plot (i==n) or 5 otherwise, left=20
  )
}) %>%
  wrap_plots(ncol = 1, heights = rep(1, n)) +
  plot_annotation(title = "ADMIXTURE Plots",
                  theme = theme(plot.title = element_text(size = 18, hjust = 0.5)))


ggsave(file.path(output_dir, "admixplots_all_clean.png"),
       plot = combined_plot,
       bg = 'transparent',
       width = 16,
       height = 9)
```


```{r}
# ==================
#   HETEROZYGOSITY 
# ==================

heterozygosity_url <- "https://docs.google.com/spreadsheets/d/1KBqsCfPiuyno90iRJ-O0wV0HIijFncstvcIpGnpGY0k/edit?gid=1838883534#gid=1838883534"
gs4_auth(path = "/gpfs/bio/xrq24scu/fox_repo/plotting/googlesheetskey.json")
heterozygosity_data <- read_sheet(heterozygosity_url, sheet = "HeterozygosityData") %>%
  mutate(Sample = as.character((Sample))) %>%
  rename(sample = Sample)

#get heterozygosity data merged w/ order_df (order.tsv with poor quality
#samples removed)
coverage_heterozygosity <- left_join(metadata, heterozygosity_data, by = "sample")

#Discard all data w/ a mean coverage below 15x, as indicated by which samples had 
#elevated heterozygosity (in your google plot)
filtered_cov_het <- coverage_heterozygosity[coverage_heterozygosity$mean_coverage > 15,]
# Remove samples with NA coverage
filtered_cov_het <- filtered_cov_het[!is.na(filtered_cov_het$mean_coverage),]
filtered_cov_het <- filtered_cov_het[filtered_cov_het$species == "Vulpes vulpes",]
filtered_cov_het <- filtered_cov_het[!is.na(filtered_cov_het$species),]

#now get this into a plotting order you like
# Join order with heterozygosity data
merged.df <- left_join(order_df, filtered_cov_het, by = "sample")

# Clean up duplicate columns: keep order_df's region/continent, drop the ".y"
merged.df <- merged.df %>%
  mutate(
    region = coalesce(region.x, region.y),
    continent = coalesce(continent.x, continent.y)
  ) %>%
  select(-region.x, -region.y, -continent.x, -continent.y)

# Drop samples with missing heterozygosity values
merged.df <- merged.df[!is.na(merged.df$Heterozygosity), ]

# Create combined sample label
merged.df$sample_region <- paste0(merged.df$sample, " (", merged.df$region, ")")

# Enforce order from order_df
merged.df$sample_region <- factor(
  merged.df$sample_region,
  levels = paste0(order_df$sample, " (", order_df$region, ")")
)

# Use continent colors from earlier
continent_colors <- setNames(
  RColorBrewer::brewer.pal(length(unique(order_df$continent)), "Set2"),
  unique(order_df$continent)
)

# Plot
heterozygosity_plot <- ggplot(merged.df, 
                              aes(x = sample_region, y = Heterozygosity, color = continent)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Heterozygosity - 2 * Jackknife_SE,
                    ymax = Heterozygosity + 2 * Jackknife_SE),
                width = 0.2, color = "black") +
  scale_color_manual(values = continent_colors) +
  theme_minimal() +
  labs(title = "Heterozygosity by Sample",
       x = "Sample (Region)",
       y = "Heterozygosity",
       color = "Continent") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("/gpfs/bio/xrq24scu/fox_repo/plotting/heterozygosity_plot.png",
       plot = heterozygosity_plot, width = 12, height = 6)


```

```{r}
# ==========================================
#                MSMC PLOTS
# ==========================================
library(ggplot2)
library(dplyr)
library(ggrepel)
library(scales)

run_MSMC_pipeline <- function(MSMC_dir,
                              order_df,
                              continent_colors,
                              plots_dir,
                              mu = 4.5e-9,     # mutation rate (gray wolves; Montane foxes 2024)
                              gen = 2,          # generation time in years
                              highlight_samples_list = NULL,
                              filtered_df = NULL,    # optional filtering data frame (e.g., filtered_cov_het)
                              output_file_all = NULL, # specify exact output filename for full plot
                              output_file_highlight = NULL # specify exact output filename for highlight plot
) {

  # === Parameters ===
  # mu and gen come from function arguments above

  # === Load MSMC results ===
  MSMC_all_samples_files <- list.files(
    MSMC_dir,
    pattern = "*\\.msmc\\.final\\.txt$",
    full.names = TRUE
  )

  msmc_allsamples <- do.call(rbind, lapply(MSMC_all_samples_files, function(f) {
    df <- read.table(f, header = TRUE)
    # get just the number after "pop"
    #df$population_ID <- as.integer(sub(".*pop([0-9]+)\\.msmc\\.final\\.txt$", "\\1", basename(f)))
    df$sample <- sub("^(.*)\\.msmc\\.final\\.txt$", "\\1", basename(f))
    df
  }))
  msmc_allsamples


  # make a lookup table: one continent per population_ID
  # Build the lookup only from filtered samples
  pop_lookup <- order_df %>%
    semi_join(filtered_df, by = "sample") %>%   # only samples that passed coverage filter
    select(sample, continent, region) %>%
    distinct()

  # Join MSMC data with lookup and drop outgroups / low-coverage samples
  msmc_allsamples_annotated <- msmc_allsamples %>%
    left_join(pop_lookup, by = "sample") %>%
    filter(!is.na(continent))    # keep only foxes that passed the heterozygosity filter


  # === MSMC plotting function ===
  plot_MSMC_facets <- function(msmc_data, continent_colors, mu, gen,
                               highlight_samples = NULL,
                               logx_limits = c(10000, 1000000),
                               logy_limits = c(10000, 500000),
                               line_size = 0.8) {

    # Optionally restrict to highlight samples
    if (!is.null(highlight_samples)) {
      msmc_data <- msmc_data %>% filter(sample %in% highlight_samples)
    }

    # Label one point per sample (leftmost time)
    labels_df <- msmc_data %>%
      group_by(sample, continent, region) %>%
      slice_min((left_time_boundary / mu) * gen, n = 1) %>%
      ungroup()

    ggplot(msmc_data, aes(
      x = (left_time_boundary / mu) * gen,
      y = (1 / lambda_00) / (2 * mu),
      group = sample,
      color = continent
    )) +
      geom_step(size = line_size) +
      geom_text_repel(
        data = labels_df,
        aes(
          x = (left_time_boundary / mu) * gen,
          y = (1 / lambda_00) / (2 * mu),
          label = region,
          color = continent
        ),
        size = 3,
        direction = "y",
        hjust = 1,
        segment.color = NA,
        inherit.aes = FALSE
      ) +
      scale_color_manual(values = continent_colors) +
      scale_x_log10(
        limits = logx_limits,
        breaks = trans_breaks("log10", function(x) 10^x),
        labels = trans_format("log10", math_format(10^.x))
      ) +
      scale_y_log10(
        limits = logy_limits,
        breaks = trans_breaks("log10", function(x) 10^x),
        labels = trans_format("log10", math_format(10^.x))
      ) +
      facet_wrap(~ continent, scales = "fixed") +
      theme_classic() +
      theme(legend.position = "none") +
      annotation_logticks() +
      labs(x = "Time (years)", y = "Effective population size (Ne)")
  }


  # === Generate plots ===
  full_plot <- plot_MSMC_facets(msmc_allsamples_annotated, continent_colors, mu, gen)

  # === Save ===
  if (!dir.exists(plots_dir)) dir.create(plots_dir, recursive = TRUE)

  # Determine filenames — if user gave only a bare filename, prepend plots_dir
  if (!is.null(output_file_all)) {
    if (!dirname(output_file_all) %in% c(".", "")) {
      ggsave(output_file_all, full_plot, width = 20, height = 20, dpi = 300)
    } else {
      ggsave(file.path(plots_dir, output_file_all), full_plot, width = 20, height = 20, dpi = 300)
    }
  } else {
    ggsave(file.path(plots_dir, "msmc_allsamples_faceted.png"), full_plot, width = 20, height = 20, dpi = 300)
  }

  # Only make and save highlight plot if highlight_samples_list is provided
  highlight_plot <- NULL
  if (!is.null(highlight_samples_list) && length(highlight_samples_list) > 0) {

    # Allow user to specify a custom data frame for highlights
    highlight_df <- msmc_allsamples_annotated
    if (exists("highlight_df_input", inherits = FALSE) && is.data.frame(highlight_df_input)) {
      highlight_df <- highlight_df_input
    }

    highlight_plot <- plot_MSMC_facets(
      highlight_df,
      continent_colors,
      mu, gen,
      highlight_samples = highlight_samples_list
    )

    if (!is.null(output_file_highlight)) {
      if (!dirname(output_file_highlight) %in% c(".", "")) {
        ggsave(output_file_highlight, highlight_plot, width = 20, height = 20, dpi = 300)
      } else {
        ggsave(file.path(plots_dir, output_file_highlight), highlight_plot, width = 20, height = 20, dpi = 300)
      }
    } else {
      ggsave(file.path(plots_dir, "msmc_highlight_faceted.png"), highlight_plot, width = 20, height = 20, dpi = 300)
    }
  } else {
    message("ℹ️  No highlight_samples_list provided — skipping highlight plot.")
  }

  # Return data and plots for reuse
  return(list(
    msmc_data = msmc_allsamples_annotated,
    full_plot = full_plot,
    highlight_plot = highlight_plot,
    output_files = list(all = output_file_all, highlight = output_file_highlight)
  ))
}


# === Example usage ===

# 1. With filtering, highlight list, and custom filenames
automsomes <- run_MSMC_pipeline(
  MSMC_dir = "/gpfs/data/bergstrom/paula/fox_repo/MSMC/autosomal_popsize_msmc",
  order_df = order_df,
  continent_colors = continent_colors,
  plots_dir = plots_dir,
  filtered_df = filtered_cov_het,
  highlight_samples_list = c("LIS935", "S212760", "S120237", "ORC_S13-2559"),
  output_file_all = "msmc_autosomes_full.png",
  output_file_highlight = "msmc_autosomes_highlighted.png"
)

Xchr <- run_MSMC_pipeline(
  MSMC_dir = "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/X_chromosomes/MSMC/popsize_for_pseudodiploids",
  plots_dir = plots_dir,
  output_file_all = "Xchr_full.png",
  output_file_highlight = "msmc_autosomes_highlighted.png"
)


```


```{r}
# ==========================================
#                MSMC PLOTS (NON-FUNCTION-based)
# ==========================================

library(ggplot2)
library(dplyr)
library(ggrepel)
library(scales)

# === Parameters ===
mu  <- 4.5e-9   # mutation rate (gray wolves; Montane foxes 2024)
gen <- 2         # generation time in years
MSMC_allsamples_dir <- "/gpfs/data/bergstrom/paula/fox_repo/MSMC/autosomal_popsize_msmc"

# === Load MSMC results ===
MSMC_all_samples_files <- list.files(
  MSMC_allsamples_dir,
  pattern = "*\\.msmc\\.final\\.txt$",
  full.names = TRUE
)

msmc_allsamples <- do.call(rbind, lapply(MSMC_all_samples_files, function(f) {
  df <- read.table(f, header = TRUE)
  df$sample <- sub("^(.*)\\.msmc\\.final\\.txt$", "\\1", basename(f))
  df
}))

# === Annotate samples ===
pop_lookup <- order_df %>%
  semi_join(filtered_cov_het, by = "sample") %>%
  select(sample, continent, region) %>%
  distinct()

msmc_annotated <- msmc_allsamples %>%
  left_join(pop_lookup, by = "sample") %>%
  filter(!is.na(continent))

# === MSMC plotting function ===
plot_MSMC_facets <- function(msmc_data, continent_colors, mu, gen,
                             highlight_samples = NULL) {
  if (!is.null(highlight_samples))
    msmc_data <- msmc_data %>% filter(sample %in% highlight_samples)

  labels_df <- msmc_data %>%
    group_by(sample, continent, region) %>%
    slice_min((left_time_boundary / mu) * gen, n = 1) %>%
    ungroup()

  ggplot(msmc_data, aes(
    x = (left_time_boundary / mu) * gen,
    y = (1 / lambda_00) / (2 * mu),
    group = sample, color = continent)) +
    geom_step(size = 0.8) +
    geom_text_repel(data = labels_df,
      aes(label = region, color = continent),
      size = 3, direction = "y", hjust = 1, segment.color = NA) +
    scale_color_manual(values = continent_colors) +
    scale_x_log10(limits = c(1e3, 1e6), breaks = trans_breaks("log10", function(x) 10^x),
                  labels = trans_format("log10", math_format(10^.x))) +
    scale_y_log10(limits = c(1e3, 1e7), breaks = trans_breaks("log10", function(x) 10^x),
                  labels = trans_format("log10", math_format(10^.x))) +
    facet_wrap(~continent, scales = "fixed") +
    theme_classic() + theme(legend.position = "none") +
    annotation_logticks() +
    labs(x = "Time (years)", y = "Effective population size (Ne)")
}

# === Generate and save plots ===
full_plot <- plot_MSMC_facets(msmc_annotated, continent_colors, mu, gen)
highlight_samples <- c("LIS935", "S212760", "S120237", "ORC_S13-2559")
highlight_plot <- plot_MSMC_facets(msmc_annotated, continent_colors, mu, gen,
                                   highlight_samples = highlight_samples)

ggsave(file.path(plots_dir, "msmc_allsamples_faceted.png"), full_plot, width = 20, height = 20, dpi = 300)
ggsave(file.path(plots_dir, "msmc_highlight_samples_faceted.png"), highlight_plot, width = 20, height = 20, dpi = 300)
```


```{r}
# ==========================================
#      MSMC PLOTS — PSEUDODIPLOIDS (ALL FACETS, FIXED LABELS)
# ==========================================

library(ggplot2)
library(dplyr)
library(ggrepel)
library(scales)
library(stringr)
library(RColorBrewer) 

# === Parameters ===
mu  <- (4.5e-9*0.75)    # mutation rate
gen <- 2         # generation time (years)
MSMC_pseudo_dir <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/X_chromosomes/MSMC/popsize_for_pseudodiploids"
plots_dir       <- "/gpfs/data/bergstrom/paula/fox_repo/plotting"

# === Load pseudodiploid MSMC results ===
MSMC_pseudo_files <- list.files(MSMC_pseudo_dir, pattern = "*.msmc.final.txt$", full.names = TRUE)
if (length(MSMC_pseudo_files) == 0) stop("No pseudodiploid MSMC files found!")

msmc_pseudo <- do.call(rbind, lapply(MSMC_pseudo_files, function(f) {
  df <- read.table(f, header = TRUE)
  pair <- strsplit(sub("\\.msmc\\.final\\.txt$", "", basename(f)), "\\.")[[1]]
  df$sample1 <- pair[1]
  df$sample2 <- pair[2]
  df
}))

# === Annotate with sample metadata ===
#lookup <- order_df %>%
#  select(sample, continent, region)

# ensure continent is character, not numeric/factor code
#lookup <- lookup %>%
#  mutate(continent = as.character(continent))

msmc_pseudo <- msmc_pseudo %>%
  left_join(pop_lookup, by = c("sample1" = "sample")) %>%
  rename(continent1 = continent, region1 = region) %>%
  left_join(pop_lookup, by = c("sample2" = "sample")) %>%
  rename(continent2 = continent, region2 = region) %>%
  filter(!is.na(continent1), !is.na(continent2))

# === Normalize continent-pair names to ignore reversed pairs ===
normalize_pair <- function(x, y) {
  apply(cbind(x, y), 1, function(z) paste(sort(z), collapse = "-"))
}

msmc_pseudo <- msmc_pseudo %>%
  mutate(
    continent1 = as.character(continent1),
    continent2 = as.character(continent2),
    continent_pair = normalize_pair(continent1, continent2)
  )

# verify the continent_pair names
print(unique(msmc_pseudo$continent_pair))

# === Build color palette dynamically ===
unique_pairs <- sort(unique(msmc_pseudo$continent_pair))
palette_name <- "Dark2"  # alternatives: "Paired", "Accent", "Set1"
n_colors <- length(unique_pairs)

pair_colors <- setNames(
  colorRampPalette(
    brewer.pal(min(8, brewer.pal.info[palette_name, "maxcolors"]), palette_name)
  )(n_colors),
  unique_pairs
)

# === Combined faceted plot ===
combined_plot <- ggplot(msmc_pseudo, aes(
  x = (left_time_boundary / mu) * gen,
  y = (1 / lambda_00) / (2 * mu),
  group = interaction(sample1, sample2),
  color = continent_pair
)) +
  geom_step(size = 0.8, alpha = 0.8) +
  scale_color_manual(values = pair_colors, name = "Continent pair") +
  scale_x_log10(
    limits = c(1e4, 1e7),
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  scale_y_log10(
    limits = c(1e3, 1e13),
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  facet_wrap(~continent_pair, scales = "fixed") +
  theme_classic(base_size = 14) +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", size = 12),
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 13),
    panel.spacing = unit(1, "lines")
  ) +
  annotation_logticks() +
  labs(
    x = "Time (years)",
    y = "Effective population size (Ne)", #sort of true, not really, as this should be a proxy for 
    #divergence time, instead. think about units etc
    title = "MSMC Y chromosomes by continent pair"
  )

# === Save the combined plot ===
out_file <- file.path(plots_dir, "MSMC_pseudodiploids_all_pairs.png")
ggsave(out_file, combined_plot, width = 16, height = 10, dpi = 300)

message(" Combined plot saved: ", out_file)


```


```{r}
# ==========================================
#   MSMC PLOTS — PSEUDODIPLOIDS (COWPLOT VERSION)
# ==========================================

library(ggplot2)
library(dplyr)
library(ggrepel)
library(scales)
library(stringr)
library(RColorBrewer)
library(cowplot)

# === Parameters ===
mu  <- (4.5e-9*0.75)    # mutation rate
gen <- 2               # generation time (years)
MSMC_pseudo_dir <- "/gpfs/data/bergstrom/paula/fox_repo/variant_calling/X_chromosomes/MSMC/popsize_for_pseudodiploids"
plots_dir       <- "/gpfs/data/bergstrom/paula/fox_repo/plotting"

# === Load pseudodiploid MSMC results ===
MSMC_pseudo_files <- list.files(MSMC_pseudo_dir, pattern = "*.msmc.final.txt$", full.names = TRUE)
if (length(MSMC_pseudo_files) == 0) stop("No pseudodiploid MSMC files found!")

msmc_pseudo <- do.call(rbind, lapply(MSMC_pseudo_files, function(f) {
  df <- read.table(f, header = TRUE)
  pair <- strsplit(sub("\\.msmc\\.final\\.txt$", "", basename(f)), "\\.")[[1]]
  df$sample1 <- pair[1]
  df$sample2 <- pair[2]
  df
}))

# === Annotate with metadata ===
msmc_pseudo <- msmc_pseudo %>%
  left_join(pop_lookup, by = c("sample1" = "sample")) %>%
  rename(continent1 = continent, region1 = region) %>%
  left_join(pop_lookup, by = c("sample2" = "sample")) %>%
  rename(continent2 = continent, region2 = region) %>%
  filter(!is.na(continent1), !is.na(continent2))

# === Normalize continent pair names ===
normalize_pair <- function(x, y) {
  apply(cbind(x, y), 1, function(z) paste(sort(z), collapse = "-"))
}

msmc_pseudo <- msmc_pseudo %>%
  mutate(
    continent1 = as.character(continent1),
    continent2 = as.character(continent2),
    continent_pair = normalize_pair(continent1, continent2)
  )

unique_pairs <- sort(unique(msmc_pseudo$continent_pair))
print(unique_pairs)

# === Build color palette ===
palette_name <- "Dark2"
pair_colors <- setNames(
  colorRampPalette(
    brewer.pal(min(8, brewer.pal.info[palette_name, "maxcolors"]), palette_name)
  )(length(unique_pairs)),
  unique_pairs
)

# === Fixed axis limits (same as your plot) ===
xlims <- c(1e4, 1e7)
ylims <- c(1e3, 1e13)

# ==========================================
#         COWPLOT MULTI-PANEL SYSTEM
# ==========================================

ncol_facets <- 4
plot_width  <- 16
plot_height <- 12

# ---- function to create one panel ----
make_panel <- function(df_panel, pair_name) {

  p <- ggplot(df_panel, aes(
      x = (left_time_boundary / mu) * gen,
      y = (1 / lambda_00) / (2 * mu),
      group = interaction(sample1, sample2),
      color = continent_pair
    )) +
    geom_step(size = 0.8, alpha = 0.8) +
    scale_color_manual(values = pair_colors, name = "Continent pair") +
    scale_x_log10(
      limits = xlims,
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x))
    ) +
    scale_y_log10(
      limits = ylims,
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x))
    ) +
    annotation_logticks() +
    theme_classic(base_size = 14) +
    theme(
      legend.position = "none",
      axis.text = element_text(size = 10),
      axis.title = element_text(size = 12),
      plot.margin = margin(t = 5, r = 5, b = 25, l = 5)
    ) +
    labs(
      x = NULL,
      y = NULL,
      title = pair_name
    ) +
    coord_cartesian(clip = "off")

  p 
}

# ---- build panels ----
panels <- lapply(unique_pairs, function(pair) {
  df_panel <- msmc_pseudo %>% filter(continent_pair == pair)
  make_panel(df_panel, pair)
})

# ---- build shared legend ----
legend_plot <- ggplot(msmc_pseudo, aes(
    x = (left_time_boundary / mu) * gen,
    y = (1 / lambda_00) / (2 * mu),
    color = continent_pair
  )) +
  geom_step() +
  scale_color_manual(values = pair_colors, name = "Continent pair") +
  theme(legend.position = "bottom")

shared_legend <- get_legend(legend_plot)

# ---- Shared labels ----
x_label_grob <- ggdraw() + draw_label("Time (years)", size = 14)
y_label_grob <- ggdraw() + draw_label("Effective population size (Ne)",
                                      size = 14, angle = 90)

# ---- panel grid ----
panel_grid <- plot_grid(plotlist = panels, ncol = ncol_facets, align = "hv")

# ---- assemble full plot ----
left_with_panels <- plot_grid(
  y_label_grob,
  panel_grid,
  ncol = 2,
  rel_widths = c(0.06, 0.94)
)

with_x <- plot_grid(
  left_with_panels,
  x_label_grob,
  ncol = 1,
  rel_heights = c(1, 0.03)
)

final_plot <- plot_grid(
  with_x,
  shared_legend,
  ncol = 1,
  rel_heights = c(1, 0.06)
)

# ---- save ----
out_file <- file.path(plots_dir, "MSMC_pseudodiploids_all_pairs_grid.png")
ggsave(out_file, final_plot, width = plot_width, height = plot_height, dpi = 300)

message(" Combined plot saved: ", out_file)
```



```{r}
# === Directory for individual pseudodiploid plots ===
individual_dir <- file.path(plots_dir, "MSMC_pseudodiploids_individual_pairs")
if (!dir.exists(individual_dir)) {
  dir.create(individual_dir, recursive = TRUE)
  message(" Created directory: ", individual_dir)
}

# === Generate individual plots for each sample1-sample2 pair ===
pair_list <- msmc_pseudo %>%
  distinct(sample1, sample2) %>%
  mutate(pair_id = paste(sample1, sample2, sep = "_"))

for (i in seq_len(nrow(pair_list))) {
  s1 <- pair_list$sample1[i]
  s2 <- pair_list$sample2[i]
  pid <- pair_list$pair_id[i]

  df_sub <- msmc_pseudo %>% filter(sample1 == s1, sample2 == s2)

  # determine the proper continent pair color
  cp <- unique(df_sub$continent_pair)
  col <- pair_colors[cp]

  p <- ggplot(df_sub, aes(
    x = (left_time_boundary / mu) * gen,
    y = (1 / lambda_00) / (2 * mu)
  )) +
    geom_step(size = 0.9, color = col, alpha = 0.9) +
    scale_x_log10(
      limits = c(1e4, 1e6),
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x))
    ) +
    scale_y_log10(
      limits = c(1e3, 1e13),
      breaks = trans_breaks("log10", function(x) 10^x),
      labels = trans_format("log10", math_format(10^.x))
    ) +
    theme_classic(base_size = 14) +
    theme(
      axis.text = element_text(size = 11),
      axis.title = element_text(size = 13)
    ) +
    annotation_logticks() +
    labs(
      x = "Time (years)",
      y = "Effective population size (Ne)",
      title = paste0("MSMC Y chromosome pair: ", s1, " × ", s2),
      subtitle = paste("Continent pair:", cp)
    )

  out_file_indiv <- file.path(individual_dir, paste0("MSMC_", pid, ".png"))
  ggsave(out_file_indiv, p, width = 8, height = 6, dpi = 300)

  message(" Saved individual plot: ", out_file_indiv)
}

```

